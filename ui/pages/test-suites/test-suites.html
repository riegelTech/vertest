<main-layout>
    <div>
        <md-table v-model="testSuites" md-sort="name" md-sort-order="asc" md-card>
            <md-table-toolbar>
                <h1 class="md-title">Test suites
                    <md-button class="md-fab md-primary md-dense md-icon-button md-elevation-1" @click="showCreatePopin">
                        <md-icon>add</md-icon>
                    </md-button>
                </h1>
            </md-table-toolbar>
            <md-table-row slot="md-table-row" slot-scope="{ item }">
                <md-table-cell md-label="Name" md-sort-by="name"><strong><router-link :to="`/test-suites/${item._id}`">{{ item.name }}</router-link></strong></md-table-cell>
                <md-table-cell md-label="Repository" md-sort-by="repositoryName">{{ item.repositoryAddress }}</md-table-cell>
                <md-table-cell md-label="Progress" md-numeric md-sort-by="progress.percent">
                    <md-progress-bar md-mode="determinate" :md-value="item.progress.percent"></md-progress-bar>
                    {{ item.progress.percent }}%
                </md-table-cell>
                <md-table-cell md-label="Git branch" md-sort-by="gitBranch">
                    <a class="change-git-branch-button" @click="toggleTestSuiteGitBranch(item._id)">
                        {{ item.gitBranch }}
                        <md-tooltip md-direction="top">Change test suite GIT branch</md-tooltip>
                    </a>
                </md-table-cell>
                <md-table-cell md-label="Action">
                    <md-button v-if="item.status === 'to_update'" class="md-icon-button md-mini md-accent" @click="solveTestSuiteDiff(item._id)">
                        <md-icon>warning</md-icon>
                        <md-tooltip md-direction="top">Valid GIT modifications on test suite, as repository has been updated</md-tooltip>
                    </md-button>
                    <md-button v-if="item.status === 'to_toggle_branch'" class="md-icon-button md-mini md-accent" @click="toggleTestSuiteGitBranch(item._id)">
                        <md-icon>warning</md-icon>
                        <md-tooltip md-direction="top">Choose a new branch for test suite, as current branch has been deleted</md-tooltip>
                    </md-button>
                    <md-button class="md-icon-button md-mini md-accent" @click="deleteTestSuite(item._id)">
                        <md-icon>delete</md-icon>
                        <md-tooltip md-direction="top">Delete test suite</md-tooltip>
                    </md-button>
                </md-table-cell>
            </md-table-row>
        </md-table>
    </div>
    <md-dialog :md-active.sync="createPopin.show">
        <md-dialog-title>Please select a repository and a git branch</md-dialog-title>
        <form>
            <md-steppers md-linear :md-active-step.sync="createPopin.activeStep">
                <md-step id="first" md-label="Main informations" :md-error="createPopin.firstStepError">
                    <md-field>
                        <label for="testSuiteName">Test suite name</label>
                        <md-input name="testSuiteName" v-model="createPopin.testSuiteName" type="text" required />
                    </md-field>
                    <md-field>
                        <label for="repositoryAddress">Repository address</label>
                        <md-input name="repositoryAddress" v-model="createPopin.repositoryAddress" type="text" required />
                    </md-field>
                    <md-field class="auth-type">
                        <div>
                            <label for="repositoryAuthType">Repository authentication type</label>
                        </div>
                        <div>
                            <md-radio class="md-primary" v-model="createPopin.repositoryAuthType" :value="authTypes.NONE">None</md-radio>
                            <md-radio class="md-primary" v-model="createPopin.repositoryAuthType" :value="authTypes.PASS">Login - password</md-radio>
                            <md-radio class="md-primary" v-model="createPopin.repositoryAuthType" :value="authTypes.KEY">SSH key</md-radio>
                        </div>
                    </md-field>
                    <div :hidden="createPopin.repositoryAuthType !== authTypes.PASS">
                        <md-field>
                            <label for="repositoryLogin">Login</label>
                            <md-input name="repositoryLogin" v-model="createPopin.repositoryLogin" type="text" />
                        </md-field>
                        <md-field>
                            <label for="repositoryPass">Password</label>
                            <md-input name="repositoryPass" v-model="createPopin.repositoryPass" type="password" />
                        </md-field>
                    </div>
                    <div :hidden="createPopin.repositoryAuthType !== authTypes.KEY">
                        <md-field>
                            <label for="repositorySshKey">SSH key file</label>
                            <md-select v-model="createPopin.repositorySshKey" name="repositorySshKey">
                                <md-option v-for="repositorySshKey in createPopin.availableSshKeys" :value="repositorySshKey.name" :key="repositorySshKey.name">{{ repositorySshKey.name }}</md-option>
                            </md-select>
                        </md-field>
                        <md-field>
                            <label for="repositorySshKeyUser">Ssh key user</label>
                            <md-input name="repositorySshKeyUser" v-model="createPopin.repositorySshKeyUser" type="text" />
                        </md-field>
                        <md-field>
                            <label for="repositorySshKeyPass">Key passphrase (leave blank if key has no passphrase)</label>
                            <md-input name="repositorySshKeyPass" v-model="createPopin.repositorySshKeyPass" type="password" />
                        </md-field>
                    </div>
                    <md-button class="md-raised md-primary" @click="getRepoBranches()">Next</md-button>
                </md-step>
                <md-step id="second" md-label="Repository GIT branch" :md-error="createPopin.secondStepError">
                    <md-field>
                        <label for="repositoryBranch">Choose GIT branch</label>
                        <md-select v-model="createPopin.repositoryBranch" name="repositoryBranch">
                            <md-option v-for="gitBranch in createPopin.availableGitBranches" :value="gitBranch" :key="gitBranch">{{ gitBranch }}</md-option>
                        </md-select>
                    </md-field>
                    <md-button class="md-raised md-primary" @click="getRepoFiles()">Next</md-button>
                </md-step>
                <md-step id="third" md-label="File selection" :md-error="createPopin.thirdStepError">
                    <md-field>
                        <label for="filePatterns">Configure which files to add to the set of tests</label>
                        <md-input name="filePatterns" v-model="createPopin.fieldFilePattern" type="text" />
                        <md-button class="md-raised md-primary md-dense md-icon-button md-small" @click="addFilePattern()">
                            <md-icon>add</md-icon>
                        </md-button>
                    </md-field>
                    <div>
                        <ul>
                            <li v-for="(filePattern, filePatternIndex) in createPopin.filePatterns" :value="filePattern" :key="filePatternIndex">
                                <md-button class="md-icon-button md-mini md-accent" @click="deleteFilePattern(filePatternIndex)">
                                    <md-icon>delete</md-icon>
                                    <md-tooltip md-direction="top">Remove this pattern</md-tooltip>
                                </md-button>
                                {{ filePattern }}
                            </li>
                        </ul>
                    </div>
                    <div class="md-layout md-gutter">
                        <div class="md-layout-item">
                            <strong>Available files</strong>
                            <file-tree class="item"
                                       :item="createPopin.availableFilesTree"
                                       :testSuiteId="''">
                            </file-tree>
                        </div>
                        <div class="md-layout-item">
                            <file-tree class="item"
                                       :item="createPopin.selectedFilesTree"
                                       :testSuiteId="''">
                            </file-tree>
                        </div>
                    </div>
                    <md-button class="md-raised md-primary" @click="createTestSuite()">Create test suite</md-button>
                </md-step>
            </md-steppers>
        </form>
    </md-dialog>
    <md-dialog :md-active.sync="toggleBranchPopin.show">
        <md-dialog-title>Please select a new git branch</md-dialog-title>
        <form>
            <md-field>
                <label for="newGitBranch">New git branch</label>
                <md-select v-model="toggleBranchPopin.selectedGitBranch" name="gitBranch">
                    <md-option v-for="gitBranch in toggleBranchPopin.availableGitBranches" :value="gitBranch" :key="gitBranch">{{ gitBranch }}</md-option>
                </md-select>
            </md-field>
            <md-dialog-actions>
                <md-button class="md-primary" @click="solveTestSuiteDiff(toggleBranchPopin.testSuiteId, toggleBranchPopin.selectedGitBranch)">Valid</md-button>
            </md-dialog-actions>
        </form>
    </md-dialog>
    <md-dialog :md-active.sync="diffPopin.show">
        <md-dialog-title>Diff viewer</md-dialog-title>
        <md-tabs v-if="!diffPopin.diff.isEmpty" md-dynamic-height>
            <md-tab md-label="Modified" v-if="diffPopin.diff.modifiedPatches.length > 0">
                <md-content class="md-scrollbar">
                    <div v-for="patch in diffPopin.diff.modifiedPatches">
                        <strong v-if="patch.file === patch.newFile">{{ patch.file }}</strong>
                        <strong v-if="patch.file !== patch.newFile">{{ patch.file }} => {{ patch.newFile }}</strong>
                        <test-case-state :testState="patch.test.status" :displayCurrentState="true" :displayStateSwitch="true" v-on:change-test-status="changeTestStatus(patch.test.testFilePath, $event)"></test-case-state>
                        <diff-viewer :hunks="patch.hunks"></diff-viewer>
                    </div>
                </md-content>
            </md-tab>
            <md-tab md-label="Deleted" v-if="diffPopin.diff.deletedPatches.length > 0">
                <md-content class="md-scrollbar">
                    <div v-for="patch in diffPopin.diff.deletedPatches">
                        <strong>{{ patch.file }}</strong>
                        <test-case-state :testState="patch.test.status" :displayCurrentState="true"></test-case-state>
                    </div>
                </md-content>
            </md-tab>
            <md-tab md-label="Added" v-if="diffPopin.diff.addedPatches.length > 0">
                <md-content class="md-scrollbar">
                    <div v-for="patch in diffPopin.diff.addedPatches">
                        <strong>{{ patch.file }}</strong>
                    </div>
                </md-content>
            </md-tab>
            <md-tab md-label="Renamed" v-if="diffPopin.diff.renamedPatches.length > 0">
                <md-content class="md-scrollbar">
                    <ul>
                        <li v-for="patch in diffPopin.diff.renamedPatches">
                            <strong>{{ patch.file }} => {{ patch.newFile }}</strong>
                        </li>
                    </ul>
                </md-content>
            </md-tab>
        </md-tabs>
        <md-content v-if="diffPopin.diff.isEmpty">
            There is no differences between current local and target repository state.
        </md-content>
        <md-button @click="submitNewTestsStatuses">Got it !</md-button>
    </md-dialog>
    <md-dialog :md-active.sync="loginPopup.show" :md-click-outside-to-close="false" :md-close-on-esc="false">
        <md-dialog-title>Login</md-dialog-title>
        <form @submit="login">
            <md-field>
                <label for="login">Login</label>
                <md-input id="login" name="login" v-model="userLogin" type="text" @keyup.enter.native="login" />
            </md-field>
            <md-field>
                <label for="password">Password</label>
                <md-input id="password" name="password" v-model="userPassword" type="password" @keyup.enter.native="login" />
            </md-field>
            <md-dialog-actions>
                <md-button class="md-primary" @click="login">Send</md-button>
            </md-dialog-actions>
        </form>
    </md-dialog>
</main-layout>